# Magic8‚ÄëCompanion ‚Äî Implementation Guide\n\n*Version 1.2 ‚Äì June 7 2025*\n\n---\n\n## 0  Purpose & Scope\n\nThis guide provides **exactly** how to build the **Magic8‚ÄëCompanion**: a focused orchestration system that consumes Magic8's 5‚Äëminute predictions and provides two core functions:\n\n1. **Combo Type Recommendation** ‚Äî At scheduled checkpoints (10:30, 11:00, 12:30, 14:45 ET), analyze Magic8's recommendations and determine which 0‚ÄëDTE option combo type is most favorable\n2. **Exit Signal Generation** ‚Äî Monitor open positions and alert when market conditions turn adverse\n\n**Key Principles:**\n- **Wrapper‚Äëfirst** ‚Äî Orchestrate around Magic8 and IB API; build minimal custom logic\n- **Core‚Äëonly** ‚Äî Focus solely on combo type selection and risk management  \n- **Ship‚Äëfast** ‚Äî Deploy as single service in ‚â§ 7 trading days\n\n**What Magic8‚ÄëCompanion Does NOT Do:**\n- Calculate Greeks or gamma exposure (Magic8 provides this)\n- Form specific option combos (Magic8 provides strikes/prices)\n- Predict trends or ranges (Magic8 provides this)\n- Execute trades continuously (scheduled checkpoints only)\n\n---\n\n## 1  High‚ÄëLevel Architecture\n\n```mermaid\nflowchart TD\n  A[Magic8 5-min Feed] -->|prediction data| B[Magic8‚ÄëCompanion]\n  C[IB Portfolio API] -->|position data| B\n  B --> D[Combo Type Scorer]\n  B --> E[Position Monitor]\n  D -->|scheduled| F[Discord Alerts]\n  E -->|real-time| F\n  B --> G[(SQLite Position DB)]\n```\n\n**Data Flow:**\n1. **Consume** Magic8's 5‚Äëminute predictions (trend, range, example trades)\n2. **Score** which combo type (Butterfly/Iron Condor/Vertical) is most favorable\n3. **Track** open positions via IB Portfolio API\n4. **Monitor** positions against exit triggers\n5. **Alert** via Discord when conditions change\n\n---\n\n## 2  Magic8 Integration Specification\n\n### 2.1 Magic8 Data Format\nBased on the sample output, Magic8 provides:\n\n```json\n{\n  \"timestamp\": \"2025-05-22T11:41:19\",\n  \"spot_price\": 5848.66,\n  \"trend\": \"Up\",\n  \"predicted_close\": 5849.52,\n  \"strength\": 0.53,\n  \"range\": 10.0,\n  \"targets\": [5850.0, 5860.0],\n  \"levels\": {\n    \"calls\": 5900.0,\n    \"puts\": 5850.0,\n    \"center\": 5875.0,\n    \"delta\": 5846.21,\n    \"gamma\": 5861.65,\n    \"interest\": 5831.99\n  },\n  \"example_trades\": {\n    \"butterfly\": {\n      \"strikes\": \"5905/5855/5805\",\n      \"type\": \"CALL\",\n      \"price\": 24.82,\n      \"action\": \"BUY\"\n    },\n    \"iron_condor\": {\n      \"strikes\": \"5905/5910/5780/5775\", \n      \"type\": \"CALL/PUT\",\n      \"price\": 0.43,\n      \"action\": \"SELL\"\n    },\n    \"vertical\": {\n      \"strikes\": \"5820/5815\",\n      \"type\": \"PUT\", \n      \"price\": 0.9,\n      \"action\": \"SELL\"\n    }\n  }\n}\n```\n\n### 2.2 Magic8 Integration Methods\n\n**Option A: File Polling** (Recommended for MVP)\n```python\n# Check for new Magic8 output file every 30 seconds\nmagic8_file = \"/path/to/magic8/output.json\"\n```\n\n**Option B: HTTP API** (If available)\n```python\n# Poll Magic8 REST endpoint\nmagic8_url = \"https://magic8.api/latest\"\n```\n\n**Option C: WebSocket Feed** (Future enhancement)\n```python\n# Real-time Magic8 predictions\nmagic8_ws = \"wss://magic8.feed/predictions\"\n```\n\n---\n\n## 3  Component Stack (Minimal)\n\n| Layer               | Technology              | Purpose                           |\n| ------------------- | ----------------------- | --------------------------------- |\n| Magic8 Integration  | `requests` / file I/O   | Consume Magic8 predictions        |\n| Portfolio Data      | `ib_async`              | Track open positions              |\n| Combo Scoring       | Custom Python module    | Type favorability logic           |\n| Position Monitoring | Custom Python module    | Exit signal generation            |\n| Alerts              | `discord.py`            | Notifications                     |\n| Persistence         | SQLite                  | Position tracking DB              |\n| Scheduling          | `APScheduler`           | Checkpoint execution              |\n\n---\n\n## 3.1  ü§î Why Does Magic8-Companion Need Market Analysis?\n\n**The Challenge**: Magic8 provides specific trade recommendations, but **NOT** comparative scoring of which combo type is most favorable at any given time.\n\n**What Magic8 Provides:**\n- ‚úÖ Specific Butterfly recommendation (strikes: 5905/5855/5805, price: $24.82)\n- ‚úÖ Specific Iron Condor recommendation (strikes: 5905/5910/5780/5775, price: $0.43)\n- ‚úÖ Specific Vertical recommendation (strikes: 5820/5815, price: $0.90)\n- ‚úÖ Trend direction and strength\n- ‚úÖ Predicted range and targets\n\n**What Magic8 Does NOT Provide:**\n- ‚ùå \"Butterfly is 85% favorable, Condor is 60% favorable, Vertical is 45% favorable\"\n- ‚ùå Comparative combo type scoring\n- ‚ùå Current implied volatility environment assessment\n- ‚ùå Market condition categorization for combo selection\n\n### 3.2 Hybrid Approach: Magic8 + Lightweight Analysis\n\n**Magic8-Companion's Strategy:**\n\n```mermaid\nflowchart LR\n    A[Magic8 Data<br/>trend, range, strength] --> C[Combo Type Scorer]\n    B[Light Market Analysis<br/>IV, basic GEX] --> C\n    C --> D[Recommendation<br/>\"Butterfly 85% favorable\"]\n```\n\n**Magic8 Data Used:**\n- Trend strength (0.53) ‚Üí Assess directional vs neutral market\n- Range prediction (10 points) ‚Üí Assess tight vs wide expected movement\n- Greek-based levels ‚Üí Assess gamma pinning probability\n\n**Lightweight Market Analysis Added:**\n- **Implied Volatility Environment** ‚Üí High IV favors credit spreads (Condors/Butterflies)\n- **Basic Gamma Exposure** ‚Üí Near gamma flip favors Butterflies (pinning)\n- **Current Option Spreads** ‚Üí Wide spreads indicate stressed conditions\n\n**Combined Scoring:**\n```python\ndef score_combo_favorability(magic8_data, market_data):\n    \"\"\"\n    Combine Magic8's predictions with lightweight market analysis\n    to score which combo TYPE is most favorable\n    \"\"\"\n    \n    # Magic8 insights\n    trend_strength = magic8_data['strength']  # 0.53\n    range_size = magic8_data['range']         # 10.0\n    gamma_level = magic8_data['levels']['gamma']  # 5861.65\n    \n    # Light market analysis  \n    iv_rank = market_data['iv_percentile']    # Current IV vs historical\n    gex_distance = market_data['gex_distance'] # Distance to gamma flip\n    spread_quality = market_data['spread_avg'] # Option liquidity\n    \n    # Scoring logic combines both sources...\n```\n\n**Scope Boundary:**\n- ‚úÖ **Lightweight**: Basic IV calculation, simple GEX distance, spread analysis\n- ‚ùå **Heavy**: Full option chain processing, complex gamma walls, real-time Greeks for all strikes\n- ‚úÖ **Wrapper-first**: Use proven libraries (`py_vollib_vectorized`, `spx-gamma-exposure`) minimally\n- ‚ùå **Reinventing**: Building Greeks engines or GEX calculators from scratch\n\n---\n\n## 4  Combo Type Scoring Logic\n\n### 4.1 Enhanced Scoring Matrix\n\nCombines Magic8 data with lightweight market analysis:\n\n```python\ndef score_combo_types(magic8_data, market_analysis):\n    \"\"\"Score combo types using Magic8 + market data\"\"\"\n    \n    # Magic8 data\n    spot = magic8_data['spot_price']\n    trend_strength = magic8_data['strength']\n    range_size = magic8_data['range']\n    center = magic8_data['levels']['center']\n    \n    # Light market analysis\n    iv_rank = market_analysis['iv_percentile']  # 0-100\n    gex_distance = abs(spot - market_analysis['gex_flip']) / spot\n    \n    scores = {}\n    \n    # BUTTERFLY: Very low vol, pinning at center\n    butterfly_score = 0\n    if abs(spot - center) / spot < 0.005:  # Within 0.5% of center\n        butterfly_score += 30\n    if range_size < 15:  # Tight predicted range\n        butterfly_score += 25\n    if trend_strength < 0.6:  # Weak/neutral trend\n        butterfly_score += 20\n    if gex_distance < 0.01:  # Near gamma flip (pinning)\n        butterfly_score += 15\n    if iv_rank > 50:  # High IV (credit spread benefit)\n        butterfly_score += 10\n    \n    # IRON CONDOR: Range-bound, moderate vol\n    condor_score = 0\n    if range_size < 25:  # Range-bound expectation\n        condor_score += 35\n    if 0.3 <= trend_strength <= 0.7:  # Neutral to weak trend\n        condor_score += 30\n    if iv_rank > 40:  # Moderate+ IV\n        condor_score += 20\n    if gex_distance < 0.02:  # Reasonable gamma proximity\n        condor_score += 15\n    \n    # VERTICAL: Strong trend, higher vol\n    vertical_score = 0\n    if trend_strength > 0.6:  # Strong directional trend\n        vertical_score += 40\n    if range_size > 20:  # Expecting significant movement\n        vertical_score += 30\n    if iv_rank > 30:  # Sufficient IV for credit\n        vertical_score += 20\n    if gex_distance > 0.02:  # Away from gamma influence\n        vertical_score += 10\n    \n    return {\n        'butterfly': min(butterfly_score, 100),\n        'iron_condor': min(condor_score, 100),\n        'vertical': min(vertical_score, 100)\n    }\n```\n\n### 4.2 Market Analysis Module\n\n```python\ndef get_market_analysis(ib_client):\n    \"\"\"Lightweight market analysis for combo scoring\"\"\"\n    \n    # Get basic option chain (ATM options only)\n    atm_options = ib_client.get_atm_options(['SPX'], days_to_expiry=0)\n    \n    # Calculate IV percentile (simple)\n    current_iv = np.mean([opt['implied_vol'] for opt in atm_options])\n    iv_percentile = calculate_iv_rank(current_iv)  # vs 30-day history\n    \n    # Basic GEX calculation (using SPX-Gamma-Exposure)\n    gex_data = calculate_basic_gex(atm_options)\n    gex_flip = gex_data['zero_gamma_level']\n    \n    # Option spread quality\n    spreads = [opt['ask'] - opt['bid'] for opt in atm_options]\n    avg_spread = np.mean(spreads)\n    \n    return {\n        'iv_percentile': iv_percentile,\n        'gex_flip': gex_flip, \n        'spread_avg': avg_spread,\n        'liquidity_score': 100 if avg_spread < 5 else 50\n    }\n```\n\n### 4.3 Recommendation Threshold\n\nOnly recommend if score ‚â• 70 and clearly best option:\n\n```python\ndef generate_recommendation(scores):\n    \"\"\"Generate combo type recommendation\"\"\"\n    best_combo = max(scores, key=scores.get)\n    best_score = scores[best_combo]\n    \n    # Must score >= 70 and be 15+ points ahead\n    if best_score >= 70:\n        second_best = sorted(scores.values())[-2]\n        if best_score - second_best >= 15:\n            return {\n                'recommendation': best_combo,\n                'score': best_score,\n                'confidence': 'HIGH' if best_score >= 85 else 'MEDIUM'\n            }\n    \n    return {'recommendation': 'NONE', 'reason': 'No clear favorite'}\n```\n\n---\n\n## 5  Exit Signal Logic\n\nMonitor positions and trigger exits when:\n\n### 5.1 Exit Triggers\n\n```python\ndef check_exit_signals(position, magic8_data):\n    \"\"\"Check if position should be exited\"\"\"\n    \n    spot = magic8_data['spot_price']\n    predicted_range = magic8_data['targets']\n    \n    exit_signals = []\n    \n    # 1. Position drift beyond profit zone\n    if position['type'] == 'butterfly':\n        center_strike = position['center_strike']\n        wing_width = position['wing_width']\n        \n        distance_from_center = abs(spot - center_strike)\n        if distance_from_center > (wing_width * 0.75):\n            exit_signals.append({\n                'trigger': 'POSITION_DRIFT', \n                'reason': f'Spot {spot} > 75% from center {center_strike}'\n            })\n    \n    elif position['type'] == 'iron_condor':\n        short_put = position['short_put_strike']\n        short_call = position['short_call_strike']\n        \n        if spot <= short_put * 1.02 or spot >= short_call * 0.98:\n            exit_signals.append({\n                'trigger': 'POSITION_DRIFT',\n                'reason': f'Spot {spot} approaching short strikes'\n            })\n    \n    # 2. Magic8 range no longer favorable\n    if position['type'] == 'butterfly':\n        if not (predicted_range[0] <= position['center_strike'] <= predicted_range[1]):\n            exit_signals.append({\n                'trigger': 'RANGE_SHIFT',\n                'reason': f\"Predicted range {predicted_range} excludes center {position['center_strike']}\"\n            })\n    \n    # 3. Trend reversal for directional trades\n    if position['type'] == 'vertical':\n        position_direction = position['direction']  # 'bull' or 'bear'\n        magic8_trend = magic8_data['trend'].lower()\n        \n        if (position_direction == 'bull' and magic8_trend == 'down') or \\\n           (position_direction == 'bear' and magic8_trend == 'up'):\n            exit_signals.append({\n                'trigger': 'TREND_REVERSAL',\n                'reason': f\"Position {position_direction} vs Magic8 {magic8_trend}\"\n            })\n    \n    # 4. Circuit breakers\n    if position['unrealized_pnl'] <= -2000:  # $2k loss limit per position\n        exit_signals.append({\n            'trigger': 'LOSS_LIMIT',\n            'reason': f\"Loss ${abs(position['unrealized_pnl'])} exceeds limit\"\n        })\n    \n    return exit_signals\n```\n\n---\n\n## 6  Scheduled Execution Framework\n\n### 6.1 Checkpoint Schedule\n\n```python\nfrom apscheduler.schedulers.asyncio import AsyncIOScheduler\nfrom datetime import datetime\nimport pytz\n\ndef setup_scheduler():\n    \"\"\"Setup scheduled checkpoints\"\"\"\n    \n    scheduler = AsyncIOScheduler()\n    est = pytz.timezone('America/New_York')\n    \n    # Schedule checkpoint functions\n    scheduler.add_job(\n        run_checkpoint,\n        'cron',\n        hour=10, minute=30,\n        timezone=est,\n        id='checkpoint_1030'\n    )\n    \n    scheduler.add_job(\n        run_checkpoint,\n        'cron', \n        hour=11, minute=0,\n        timezone=est,\n        id='checkpoint_1100'\n    )\n    \n    scheduler.add_job(\n        run_checkpoint,\n        'cron',\n        hour=12, minute=30, \n        timezone=est,\n        id='checkpoint_1230'\n    )\n    \n    scheduler.add_job(\n        run_checkpoint,\n        'cron',\n        hour=14, minute=45,\n        timezone=est,\n        id='checkpoint_1445'\n    )\n    \n    return scheduler\n\nasync def run_checkpoint():\n    \"\"\"Execute scheduled checkpoint logic\"\"\"\n    \n    # 1. Get latest Magic8 prediction\n    magic8_data = await get_latest_magic8_data()\n    \n    # 2. Get light market analysis\n    market_analysis = await get_market_analysis(ib_client)\n    \n    # 3. Check current positions\n    positions = await get_current_positions()\n    \n    if positions:\n        # Monitor existing positions for exit signals\n        await check_position_exits(positions, magic8_data)\n    else:\n        # Generate new combo type recommendation  \n        await generate_combo_recommendation(magic8_data, market_analysis)\n```\n\n---\n\n## 7  Position Tracking\n\n### 7.1 Position Data Structure\n\n```python\n# positions.db (SQLite)\nCREATE TABLE positions (\n    id INTEGER PRIMARY KEY,\n    symbol TEXT NOT NULL,\n    combo_type TEXT NOT NULL,  -- 'butterfly', 'iron_condor', 'vertical'\n    direction TEXT,            -- 'bull', 'bear', 'neutral'\n    entry_time TIMESTAMP,\n    center_strike REAL,\n    wing_width REAL,\n    short_put_strike REAL,\n    short_call_strike REAL,\n    entry_credit REAL,\n    max_loss REAL,\n    current_pnl REAL,\n    status TEXT DEFAULT 'OPEN'  -- 'OPEN', 'CLOSED', 'MONITORING'\n);\n```\n\n### 7.2 Position Sync\n\n```python\nasync def sync_positions_with_ib():\n    \"\"\"Sync position DB with IB portfolio\"\"\"\n    \n    ib_positions = await ib_client.get_positions()\n    db_positions = get_db_positions()\n    \n    for ib_pos in ib_positions:\n        if is_option_combo(ib_pos):\n            update_position_pnl(ib_pos)\n    \n    # Mark closed positions\n    for db_pos in db_positions:\n        if not position_exists_in_ib(db_pos):\n            mark_position_closed(db_pos)\n```\n\n---\n\n## 8  Project Layout (Simplified)\n\n```\nmagic8_companion/\n‚îú‚îÄ‚îÄ main.py                 # Main orchestrator\n‚îú‚îÄ‚îÄ config.py              # Configuration management\n‚îú‚îÄ‚îÄ modules/\n‚îÇ   ‚îú‚îÄ‚îÄ magic8_client.py    # Magic8 integration\n‚îÇ   ‚îú‚îÄ‚îÄ combo_scorer.py     # Type scoring logic\n‚îÇ   ‚îú‚îÄ‚îÄ market_analysis.py  # Lightweight market analysis\n‚îÇ   ‚îú‚îÄ‚îÄ position_monitor.py # Exit signal generation\n‚îÇ   ‚îú‚îÄ‚îÄ ib_client.py        # IB portfolio integration\n‚îÇ   ‚îî‚îÄ‚îÄ alert_manager.py    # Discord notifications\n‚îú‚îÄ‚îÄ utils/\n‚îÇ   ‚îú‚îÄ‚îÄ db_client.py        # SQLite operations\n‚îÇ   ‚îî‚îÄ‚îÄ scheduler.py        # Checkpoint scheduling\n‚îú‚îÄ‚îÄ data/\n‚îÇ   ‚îî‚îÄ‚îÄ positions.db        # SQLite database\n‚îú‚îÄ‚îÄ tests/\n‚îÇ   ‚îî‚îÄ‚îÄ test_*.py           # Unit tests\n‚îú‚îÄ‚îÄ docker-compose.yml\n‚îú‚îÄ‚îÄ requirements.txt\n‚îî‚îÄ‚îÄ .env.example\n```\n\n---\n\n## 9  Infrastructure (Minimal)\n\n### 9.1 Docker Compose\n\n```yaml\nversion: '3.8'\n\nservices:\n  magic8_companion:\n    build: .\n    environment:\n      - MAGIC8_SOURCE=${MAGIC8_SOURCE:-file}\n      - MAGIC8_FILE_PATH=${MAGIC8_FILE_PATH:-/data/magic8_output.json}\n      - IB_HOST=${IB_HOST:-host.docker.internal}\n      - IB_PORT=${IB_PORT:-7497}\n      - DISCORD_WEBHOOK=${DISCORD_WEBHOOK}\n      - TZ=America/New_York\n    volumes:\n      - ./data:/app/data\n      - ${MAGIC8_DATA_PATH}:/data\n    depends_on:\n      - health_check\n\n  health_check:\n    image: busybox\n    command: sleep 5\n```\n\n### 9.2 Configuration\n\n```python\n# config.py\nfrom pydantic_settings import BaseSettings\n\nclass Settings(BaseSettings):\n    # Magic8 Integration\n    magic8_source: str = \"file\"  # \"file\", \"http\", \"websocket\"\n    magic8_file_path: str = \"/data/magic8_output.json\"\n    magic8_url: str = \"\"\n    magic8_poll_interval: int = 30  # seconds\n    \n    # IB Connection\n    ib_host: str = \"127.0.0.1\"\n    ib_port: int = 7497\n    ib_client_id: int = 2\n    \n    # Alerts\n    discord_webhook: str = \"\"\n    \n    # Risk Limits\n    max_daily_loss: float = 5000\n    max_position_loss: float = 2000\n    \n    # Scoring Thresholds\n    min_recommendation_score: int = 70\n    min_score_gap: int = 15\n    \n    class Config:\n        env_file = \".env\"\n\nsettings = Settings()\n```\n\n---\n\n## 10  Development Timeline (7 Days)\n\n| Day | Deliverable | Details |\n|-----|-------------|---------|\n| 1 | Setup & Magic8 Integration | Docker setup, Magic8 file parsing |\n| 2 | Market Analysis Module | Light IV/GEX calculation |\n| 3 | Combo Type Scoring Logic | Enhanced scoring with market data |\n| 4 | Position Tracking | SQLite DB, IB integration |\n| 5 | Exit Signal Logic | Position monitoring, triggers |\n| 6 | Scheduled Execution | APScheduler, checkpoint logic |\n| 7 | Alerts & Testing | Discord integration, end-to-end tests |\n\n---\n\n## 11  Quick Start\n\n### 11.1 Prerequisites\n\n- Magic8 system running and outputting predictions\n- IB TWS or Gateway running (paper trading)\n- Docker & Docker Compose\n\n### 11.2 Setup\n\n```bash\n# Clone repository\ngit clone https://github.com/birddograbbit/Magic8-Companion.git\ncd Magic8-Companion\n\n# Configure environment\ncp .env.example .env\nnano .env  # Set MAGIC8_FILE_PATH, DISCORD_WEBHOOK, etc.\n\n# Start system\ndocker-compose up -d\n\n# Monitor logs\ndocker-compose logs -f magic8_companion\n```\n\n### 11.3 Testing\n\n```bash\n# Simulate Magic8 data\necho '{\"spot_price\": 5850, \"trend\": \"Up\", \"strength\": 0.75, \"range\": 12}' > data/magic8_output.json\n\n# Check recommendations in Discord channel\n# Verify position tracking in logs\n```\n\n---\n\n## 12  Example Discord Alerts\n\n**Combo Type Recommendation:**\n```\nüéØ Magic8-Companion Checkpoint 10:30 ET\nSPX: $5,848.66\nRecommendation: BUTTERFLY (Score: 85)\nConfidence: HIGH\n\nMarket Analysis:\n‚Ä¢ Magic8 Range: 5850-5860 (tight)\n‚Ä¢ Trend Strength: 0.53 (neutral)\n‚Ä¢ IV Rank: 72% (high)\n‚Ä¢ GEX Distance: 0.3% (pinning likely)\n\nRationale: Low volatility environment with pinning probability near center\n```\n\n**Exit Signal:**\n```\nüö® EXIT SIGNAL - Butterfly Position\nCenter: 5875, Current: 5820\nTrigger: POSITION_DRIFT (spot >75% from center)\nUnrealized P&L: -$1,240\nAction Required: Close position immediately\n```\n\n---\n\n## 13  Key Success Metrics\n\n- **Checkpoint Execution**: All 4 daily checkpoints execute successfully\n- **Alert Latency**: Recommendations delivered within 60 seconds  \n- **Position Tracking**: 100% sync with IB portfolio\n- **Exit Signal Accuracy**: No false positives for 5 consecutive sessions\n- **Market Analysis Speed**: IV/GEX calculation under 10 seconds\n\n---\n\n**This implementation guide provides a focused, achievable path to deploy Magic8-Companion as a complementary system that enhances Magic8's capabilities with systematic combo type recommendations and disciplined risk management.**\n